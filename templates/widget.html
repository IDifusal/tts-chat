<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kick TTS Widget</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: transparent;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
        }
        
        #audio-unlock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
        }
        
        #audio-unlock-overlay button {
            transition: all 0.3s ease;
        }
        
        #audio-unlock-overlay button:hover {
            background: #45a049 !important;
            transform: scale(1.05);
        }
        
        .message-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        
        .message {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 18px;
            animation: slideIn 0.3s ease-out, slideOut 0.3s ease-out 4.7s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .message .username {
            color: #667eea;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .message.sound-effect {
            background: rgba(102, 126, 234, 0.9);
        }
        
        .message.subscription {
            background: rgba(46, 213, 115, 0.95);
            padding: 20px 25px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.5s ease-out, slideOut 0.5s ease-out 7s;
        }
        
        .message.subscription .sub-gif {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .message.subscription .sub-content {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .message.subscription .sub-title {
            font-size: 16px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .message.subscription .sub-username {
            font-size: 24px;
            font-weight: bold;
        }
        
        .message.follow {
            background: rgba(255, 107, 107, 0.95);
            padding: 20px 25px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            animation: slideIn 0.5s ease-out, slideOut 0.5s ease-out 6s;
        }
        
        .message.follow .follow-icon {
            font-size: 50px;
            line-height: 1;
        }
        
        .message.follow .follow-content {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .message.follow .follow-title {
            font-size: 16px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .message.follow .follow-username {
            font-size: 24px;
            font-weight: bold;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(-100%);
                opacity: 0;
            }
        }
        
        .debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            display: none;
        }
        
        .debug.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="message-container" id="message-container"></div>
    <div class="debug" id="debug">
        Status: Connecting...
    </div>
    
    <!-- Audio unlock overlay -->
    <div id="audio-unlock-overlay">
        <div style="background: rgba(0,0,0,0.9); padding: 30px; border-radius: 10px; text-align: center; max-width: 400px;">
            <h2 style="color: #fff; margin-bottom: 20px;">üîä Habilitar Audio</h2>
            <p style="color: #aaa; margin-bottom: 20px;">Los navegadores requieren interacci√≥n del usuario para reproducir audio</p>
            <button id="unlock-audio-btn" style="background: #4CAF50; color: white; border: none; padding: 15px 30px; font-size: 16px; border-radius: 5px; cursor: pointer;">
                Activar Audio
            </button>
        </div>
    </div>
    
    <script>
        const messageContainer = document.getElementById('message-container');
        const debug = document.getElementById('debug');
        let ws = null;
        let audioQueue = [];
        let isPlaying = false;
        let visualQueue = [];
        let isShowingVisual = false;
        let audioUnlocked = false;
        let pendingFirstAudio = null;
        
        const urlParams = new URLSearchParams(window.location.search);
        const showMessages = urlParams.get('show_messages') !== 'false';
        const debugMode = urlParams.get('debug') === 'true';
        
        // Detect OBS Browser Source (CEF)
        const isOBS = /obs|cef/i.test(navigator.userAgent) || window.obsstudio !== undefined;
        
        if (isOBS) {
            console.log('OBS detected - autoplay enabled');
            audioUnlocked = true; // OBS allows autoplay by default
        }
        
        if (debugMode) {
            debug.classList.add('show');
        }
        
        function updateDebug(text) {
            if (debugMode) {
                const platform = isOBS ? 'OBS' : 'Browser';
                debug.textContent = `Platform: ${platform}\nStatus: ${text}\nAudio Queue: ${audioQueue.length}\nVisual Queue: ${visualQueue.length}\nPlaying: ${isPlaying}\nUnlocked: ${audioUnlocked}`;
            }
        }
        
        function getBaseUrl() {
            // Get base URL for API calls
            if (window.location.protocol === 'file:') {
                return 'http://localhost:8000';
            }
            return '';
        }
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            let host = window.location.host;
            
            // Fallback to localhost if opened as file://
            if (!host || window.location.protocol === 'file:') {
                host = 'localhost:8000';
                console.log('Detected file:// protocol, using localhost:8000');
            }
            
            const wsUrl = `${protocol}//${host}/events`;
            console.log('Connecting to:', wsUrl);
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                updateDebug('Connected');
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected, reconnecting...');
                updateDebug('Disconnected - Reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateDebug('Error');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('Received:', data.type, data);
                handleMessage(data);
            };
        }
        
        function handleMessage(data) {
            if (data.type === 'tts_message') {
                if (showMessages) {
                    showMessage(data.username, data.text);
                }
                queueAudio(data.audio_url);
            } else if (data.type === 'sound_effect') {
                if (showMessages) {
                    showSoundEffect(data.username, data.sound_name);
                }
                queueAudio(data.audio_url);
            } else if (data.type === 'subscription') {
                queueVisualEvent(() => showSubscription(data.username), 7500);
                queueAudio('/static/sounds/subscription.mp3');
            } else if (data.type === 'follow') {
                queueVisualEvent(() => showFollow(data.username), 6500);
                queueAudio('/static/sounds/follow.mp3');
            }
        }
        
        function showMessage(username, text) {
            const message = document.createElement('div');
            message.className = 'message';
            message.innerHTML = `<span class="username">${username}:</span>${text}`;
            
            messageContainer.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 5000);
            
            while (messageContainer.children.length > 3) {
                messageContainer.removeChild(messageContainer.firstChild);
            }
        }
        
        function showSoundEffect(username, soundName) {
            const message = document.createElement('div');
            message.className = 'message sound-effect';
            message.innerHTML = `<span class="username">${username}</span> played: ${soundName}`;
            
            messageContainer.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }
        
        function queueVisualEvent(showFunction, duration) {
            visualQueue.push({ showFunction, duration });
            updateDebug('Visual queued');
            if (!isShowingVisual) {
                showNextVisual();
            }
        }
        
        function showNextVisual() {
            if (visualQueue.length === 0) {
                isShowingVisual = false;
                updateDebug('Idle (visual)');
                return;
            }
            
            isShowingVisual = true;
            const { showFunction, duration } = visualQueue.shift();
            updateDebug('Showing visual');
            
            const element = showFunction();
            
            setTimeout(() => {
                if (element && element.parentNode) {
                    element.remove();
                }
                setTimeout(showNextVisual, 100);
            }, duration);
        }
        
        function showSubscription(username) {
            const message = document.createElement('div');
            message.className = 'message subscription';
            message.innerHTML = `
                <img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExeGl4OTNpOTh2dXdjdGdsZW43ZjBseW5sanFhOWM2ZmFlbG91enEycSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/RpfIXomvjCh8I/giphy.gif" 
                     class="sub-gif" 
                     alt="Thanks">
                <div class="sub-content">
                    <div class="sub-title">Gracias por subscribirte</div>
                    <div class="sub-username">${username}</div>
                </div>
            `;
            
            messageContainer.appendChild(message);
            return message;
        }
        
        function showFollow(username) {
            const message = document.createElement('div');
            message.className = 'message follow';
            message.innerHTML = `
                <span class="follow-icon">‚ù§Ô∏è</span>
                <div class="follow-content">
                    <div class="follow-title">Nuevo seguidor</div>
                    <div class="follow-username">${username}</div>
                </div>
            `;
            
            messageContainer.appendChild(message);
            return message;
        }
        
        function queueAudio(url) {
            // Fix URL if opened as file://
            const baseUrl = getBaseUrl();
            const fullUrl = url.startsWith('http') ? url : baseUrl + url;
            
            audioQueue.push(fullUrl);
            console.log('Audio queued:', fullUrl);
            updateDebug(`Audio queued (${audioQueue.length})`);
            
            if (!isPlaying) {
                playNextAudio();
            }
        }
        
        function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                updateDebug('Idle');
                return;
            }
            
            // Check if audio needs to be unlocked first
            if (!audioUnlocked) {
                console.log('Audio locked, showing unlock overlay');
                showAudioUnlockOverlay();
                return;
            }
            
            isPlaying = true;
            const url = audioQueue.shift();
            updateDebug(`Playing (${audioQueue.length} left)`);
            console.log('Playing audio:', url);
            
            const audio = new Audio(url);
            
            audio.onended = () => {
                console.log('Audio finished');
                setTimeout(playNextAudio, 100);
            };
            
            audio.onerror = (error) => {
                console.error('Audio error for URL:', url, error);
                updateDebug('Audio error - skipping');
                setTimeout(playNextAudio, 100);
            };
            
            audio.play().catch(error => {
                console.error('Play error:', error.name, error.message);
                
                if (error.name === 'NotAllowedError') {
                    console.log('Autoplay blocked, showing unlock overlay');
                    audioUnlocked = false;
                    audioQueue.unshift(url); // Re-add to queue
                    isPlaying = false;
                    showAudioUnlockOverlay();
                } else {
                    console.error('Other play error, skipping');
                    updateDebug('Play error - skipping');
                    setTimeout(playNextAudio, 100);
                }
            });
        }
        
        function showAudioUnlockOverlay() {
            // Don't show overlay in OBS - autoplay works there
            if (isOBS) {
                console.log('OBS detected - skipping unlock overlay');
                audioUnlocked = true;
                if (audioQueue.length > 0 && !isPlaying) {
                    playNextAudio();
                }
                return;
            }
            
            const overlay = document.getElementById('audio-unlock-overlay');
            overlay.style.display = 'flex';
        }
        
        function unlockAudio() {
            console.log('Unlocking audio...');
            audioUnlocked = true;
            
            // Play silent audio to unlock
            const silentAudio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
            silentAudio.play().then(() => {
                console.log('Audio unlocked successfully');
                document.getElementById('audio-unlock-overlay').style.display = 'none';
                
                // Start playing queue
                if (audioQueue.length > 0 && !isPlaying) {
                    playNextAudio();
                }
            }).catch(error => {
                console.error('Failed to unlock audio:', error);
            });
        }
        
        // Setup audio unlock button
        document.getElementById('unlock-audio-btn').addEventListener('click', unlockAudio);
        
        // Auto-hide overlay after 5 seconds if no audio comes
        setTimeout(() => {
            const overlay = document.getElementById('audio-unlock-overlay');
            if (overlay.style.display === 'flex' && audioQueue.length === 0) {
                overlay.style.display = 'none';
            }
        }, 5000);
        
        connectWebSocket();
    </script>
</body>
</html>
